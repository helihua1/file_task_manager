# 文件任务管理系统 - 程序执行流程文档

## 系统概述

本系统是一个基于Flask的文件任务管理平台，允许用户上传TXT文件并创建定时任务，将文件内容按照设定的时间间隔自动发送到指定的目标网站。

## 核心技术栈

- **后端框架**: Python 3.8+ + Flask 2.3+
- **数据库**: MySQL 8.0+ 
- **任务调度**: APScheduler
- **前端**: HTML5 + Bootstrap 5 + jQuery
- **认证**: Flask-Login
- **ORM**: SQLAlchemy

## 系统架构

```
用户界面层 (HTML + Bootstrap)
    ↓
控制器层 (Flask Views)
    ↓
业务逻辑层 (Models + Scheduler)
    ↓
数据持久层 (MySQL + SQLAlchemy)
```

## 程序执行流程详解

### 1. 用户认证流程

**[1-1] 用户登录处理** (app/views/auth.py:login)
- **[1-1.1]** 验证用户输入的用户名和密码
- **[1-1.2]** 查找用户并验证密码哈希
- **[1-1.3]** 登录成功，更新最后登录时间
- **[1-1.4]** 重定向到相应的仪表板（用户/管理员）

**[1-2] 用户注册处理** (app/views/auth.py:register)
- **[1-2.1]** 验证注册表单数据
- **[1-2.2]** 检查用户名和邮箱唯一性
- **[1-2.3]** 创建新用户并保存到数据库

### 2. 文件上传流程

**[2-1] 用户仪表板** (app/views/user.py:dashboard)
- **[2-1.1]** 检查文件扩展名是否为txt
- **[2-1.2]** 创建用户专属上传目录
- **[2-1.3]** 获取用户统计信息
- **[2-1.4]** 获取最近的任务列表
- **[2-1.5]** 获取最近上传的文件列表

**[2-2] 文件上传处理** (app/views/user.py:upload_files)
- **[2-2.1]** 检查是否有文件被上传
- **[2-2.2]** 创建用户上传目录
- **[2-2.3]** 批量处理上传的文件
- **[2-2.4]** 生成唯一的安全文件名
- **[2-2.5]** 保存文件到磁盘
- **[2-2.6]** 保存文件信息到数据库
- **[2-2.7]** 提交数据库事务

**[2-2.1] 读取文件内容** (app/models/file.py:read_content)
- 用于任务执行时获取文件内容

### 3. 任务创建流程

**[3-1] 任务列表显示** (app/views/user.py:task_list)
- 展示用户创建的所有任务

**[3-2] 创建新任务** (app/views/user.py:create_task)
- **[3-2.1]** 验证任务配置参数
- **[3-2.2]** 解析开始和结束时间
- **[3-2.3]** 检查是否有可执行的文件
- **[3-2.4]** 创建任务记录并保存

**[3-1.4] 更新任务关联的文件数量** (app/models/task.py:update_file_count)
- 计算用户未执行的文件总数

### 4. 任务执行流程

**[4-1] 任务调度管理器** (app/scheduler.py:TaskScheduler)
- **[4-1.1]** 启动任务 - 将任务状态设置为运行中
- **[4-1.2]** 暂停任务 - 将任务状态设置为暂停
- **[4-1.3]** 完成任务 - 所有文件执行完毕后调用
- **[4-1.4]** 任务执行失败 - 遇到严重错误时调用
- **[4-1.5]** 获取任务执行进度百分比
- **[4-1.6]** 检查任务是否可以执行

**[4-2] 执行单个任务** (app/scheduler.py:execute_task)
- **[4-2.1]** 获取下一个待执行的文件
- **[4-2.2]** 获取任务信息并验证执行条件
- **[4-2.3]** 标记文件为已执行
- **[4-2.4]** 移动文件到已执行文件夹
- **[4-2.5]** 增加已执行文件计数
- **[4-2.6]** 创建成功执行记录
- **[4-2.7]** 记录系统错误

**[4-3] 将文件内容上传到目标网站** (app/scheduler.py:upload_file_to_target)
- **[4-3.1]** 读取文件内容
- **[4-3.2]** 准备HTTP请求数据
- **[4-3.3]** 发送POST请求到目标URL
- **[4-3.4]** 检查响应状态并记录结果

### 5. 管理员监控流程

**[5-1] 管理员仪表板** (app/views/admin.py:dashboard)
- **[5-1.1]** 获取系统整体统计信息
- **[5-1.2]** 获取任务执行历史记录
- **[5-1.3]** 获取用户执行统计信息

**[5-2] 用户管理** (app/views/admin.py:users)
- **[5-2.1]** 构建用户查询条件
- **[5-2.2]** 分页查询用户列表
- **[5-2.3]** 为每个用户获取统计信息

**[5-5] 任务控制操作** (app/views/admin.py:control_task)
- 管理员可以启动、暂停、停止任何用户的任务

## 数据模型关系

```
User (用户)
├── files (一对多) → File (文件)
└── tasks (一对多) → Task (任务)
                      └── task_executions (一对多) → TaskExecution (执行记录)
```

## 核心业务规则

### 文件管理规则
1. 只允许上传TXT格式文件
2. 单文件大小限制100MB
3. 每个用户有独立的文件存储目录
4. 执行成功的文件自动移动到"已执行"文件夹

### 任务执行规则
1. 任务按设定间隔自动执行
2. 每次执行选择一个未处理的文件
3. 文件内容通过HTTP POST发送到目标URL
4. 所有文件执行完成后任务自动结束
5. 任务支持启动、暂停、停止操作

### 权限控制规则
1. 普通用户只能管理自己的文件和任务
2. 管理员可以查看和控制所有用户的任务
3. 系统状态监控仅管理员可访问

## 安全特性

1. **密码安全**: 使用Werkzeug的密码哈希功能
2. **文件安全**: 上传文件名安全化处理，防止路径遍历
3. **权限控制**: 基于角色的访问控制
4. **会话管理**: Flask-Login提供会话安全
5. **输入验证**: 前后端双重数据验证

## 维护和扩展指南

### 添加新的执行方法
1. 在`app/scheduler.py`的`upload_file_to_target`方法中添加新的method处理逻辑
2. 在任务创建表单中添加新的执行方法选项
3. 更新相关文档

### 添加新的文件类型支持
1. 修改`config/__init__.py`中的`ALLOWED_EXTENSIONS`配置
2. 更新文件验证逻辑
3. 如需特殊处理，修改文件读取方法

### 数据库扩展
1. 创建新的模型类继承`db.Model`
2. 定义字段和关系
3. 运行数据库迁移命令
4. 更新相关业务逻辑

### 添加新的监控指标
1. 在管理员控制器中添加新的统计方法
2. 更新仪表板模板显示新指标
3. 如需实时更新，扩展API接口

## 部署说明

### 开发环境部署
1. 安装依赖: `pip install -r requirements.txt`
2. 配置数据库连接
3. 初始化数据库: `python scripts/init_db.py`
4. 启动应用: `python scripts/run.py`

### 生产环境部署
1. 使用WSGI服务器（如Gunicorn）
2. 配置反向代理（如Nginx）
3. 设置环境变量
4. 配置日志系统
5. 设置定时备份

## 故障排除

### 常见问题
1. **任务不执行**: 检查调度器状态和任务时间配置
2. **文件上传失败**: 检查目录权限和磁盘空间
3. **数据库连接错误**: 检查数据库配置和网络连接
4. **内存占用过高**: 检查长时间运行的任务和文件缓存

### 日志查看
- 应用日志: `logs/app.log`
- 调度器日志: 控制台输出
- 数据库日志: MySQL错误日志

## 性能优化建议

1. **数据库优化**: 为常用查询字段添加索引
2. **文件管理**: 定期清理已执行文件，避免磁盘空间不足
3. **任务调度**: 合理设置任务间隔，避免频繁执行
4. **缓存策略**: 对静态数据使用缓存机制
5. **连接池**: 配置数据库连接池优化并发性能

本文档提供了系统的完整执行流程说明，便于开发人员理解系统架构和进行维护扩展。