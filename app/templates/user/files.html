
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Êñá‰ª∂ÂàóË°®</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif; padding: 20px; }
    .container { max-width: 1000px; margin: 0 auto; }
    .toolbar { display: flex; gap: 12px; align-items: center; justify-content: space-between; margin-bottom: 16px; flex-wrap: wrap; }
    .filter { display: flex; gap: 8px; align-items: center; }
    table { width: 100%; border-collapse: collapse; background: #fff; }
    th, td { padding: 10px 12px; border-bottom: 1px solid #eee; text-align: left; }
    th { background: #fafafa; font-weight: 600; }
    .status { font-size: 12px; padding: 2px 6px; border-radius: 4px; display: inline-block; }
    .status.done { background: #e6ffed; color: #067d3d; border: 1px solid #b7f5c7; }
    .status.pending { background: #fff7e6; color: #8a5a00; border: 1px solid #ffe0a3; }
    .actions { display: flex; gap: 8px; }
    .btn { padding: 6px 10px; border: 1px solid #ddd; background: #f7f7f7; color: #333; border-radius: 4px; cursor: pointer; text-decoration: none; display: inline-block; }
    .btn.primary { background: #1677ff; border-color: #1677ff; color: #fff; }
    .btn.danger { background: #ff4d4f; border-color: #ff4d4f; color: #fff; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .pagination { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 16px; }
    .page-link { padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: #1677ff; background: #fff; }
    .page-link.active { background: #1677ff; color: #fff; border-color: #1677ff; }
    .page-link.disabled { color: #aaa; border-color: #eee; pointer-events: none; background: #fafafa; }
    .empty { padding: 24px; text-align: center; color: #666; background: #fff; border: 1px dashed #ddd; border-radius: 6px; }
    .meta { color: #666; font-size: 12px; }
    .folder-header { display: flex; justify-content: space-between; align-items: center; }
    .toggle-btn { background: transparent; border: none; cursor: pointer; padding: 4px 8px; font-size: 14px; color: #1677ff; transition: transform 0.3s; }
    .toggle-btn:hover { opacity: 0.7; }
    .toggle-btn.collapsed { transform: rotate(0deg); }
    .toggle-btn.expanded { transform: rotate(90deg); }
    .file-list-content { display: none; margin-top: 8px; }
    .file-list-content.show { display: block; }
  </style>
</head>
<body>
  <div class="container">
    <div class="toolbar">
      <h2 style="margin: 0;">Êñá‰ª∂ÂàóË°®</h2>
      <div class="filter">
        <form method="get" action="{{ url_for('user.file_list') }}">
          <label for="status">Áä∂ÊÄÅÁ≠õÈÄâÔºö</label>
          <select id="status" name="status">
            <option value="all" {% if status_filter == 'all' %}selected{% endif %}>ÂÖ®ÈÉ®</option>
            <option value="executed" {% if status_filter == 'executed' %}selected{% endif %}>Â∑≤ÊâßË°å</option>
            <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>ÂæÖÊâßË°å</option>
          </select>
          <button class="btn primary" type="submit">Â∫îÁî®Á≠õÈÄâ</button>
          <a class="btn" href="{{ url_for('user.upload_files') }}">‰∏ä‰º†Êñá‰ª∂</a>
        </form>
            <!-- Âà†Èô§Â∑≤ÊâßË°åÊñá‰ª∂ -->
        <form method="post" action="{{ url_for('user.delete_executed_files') }}" onsubmit="return confirm('Á°ÆËÆ§Âà†Èô§ÊâÄÊúâÂ∑≤ÊâßË°åÁöÑÊñá‰ª∂ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ');">
          <button class="btn danger" type="submit">Âà†Èô§Â∑≤ÊâßË°åÊñá‰ª∂</button>
        </form>
      </div>
    </div>

    
    {% if folders_data %}
      {% for folder_name, folder_info in folders_data.items() %}
        <div style="margin-bottom: 24px;">
          <div style="background: #f8f9fa; padding: 12px 16px; border-radius: 6px; border-left: 4px solid #1677ff; cursor: pointer;" 
               onclick="toggleFolder('folder-{{ loop.index }}')">
            <div class="folder-header">
              <div>
                <h3 style="margin: 0 0 4px 0; font-size: 16px; color: #333;">
                  üìÅ {{ folder_name }}
                </h3>
                <div style="font-size: 12px; color: #666;">
                  ÊÄªÊñá‰ª∂Êï∞: <strong>{{ folder_info.total_count }}</strong> | 
                  Â∑≤ÊâßË°å: <span style="color: #067d3d;">{{ folder_info.executed_count }}</span> | 
                  ÂæÖÊâßË°å: <span style="color: #8a5a00;">{{ folder_info.pending_count }}</span>
                </div>
              </div>
              <button class="toggle-btn collapsed" id="toggle-folder-{{ loop.index }}" onclick="event.stopPropagation();">‚ñ∂</button>
            </div>
          </div>
          
          <div class="file-list-content" id="folder-{{ loop.index }}">
          {% if folder_info.files %}
            <table>
              <thead>
                <tr>
                  <th style="width: 40%;">Êñá‰ª∂Âêç</th>
                  <th style="width: 15%;">Â§ßÂ∞è</th>
                  <th style="width: 25%;">‰∏ä‰º†Êó∂Èó¥</th>
                  <th style="width: 10%;">Áä∂ÊÄÅ</th>
                  <th style="width: 10%;">Êìç‰Ωú</th>
                </tr>
              </thead>
              <tbody>
                {% for f in folder_info.files %}
                  <tr>
                    <td title="{{ f.file_path }}">{{ f.filename }}</td>
                    <td>
                      {% if f.file_size is not none %}

                        {% if f.file_size >= 1024 %}
                          {{ ('%.2f' % (f.file_size / 1024)) }} KB

                        {% endif %}
                      {% else %}
                        -
                      {% endif %}
                    </td>
                    <td>
                      {% if f.upload_time %}
                        {{ f.upload_time.strftime('%Y-%m-%d %H:%M:%S') }}
                      {% else %}
                        -
                      {% endif %}
                    </td>
                    <td>
                      {% if f.is_executed %}
                        <span class="status done">Â∑≤ÊâßË°å</span>
                      {% else %}
                        <span class="status pending">ÂæÖÊâßË°å</span>
                      {% endif %}
                    </td>
                    <td class="actions">
                      <form method="post" action="{{ url_for('user.delete_file', file_id=f.id) }}" onsubmit="return confirm('Á°ÆËÆ§Âà†Èô§ËØ•Êñá‰ª∂ÂêóÔºü');">
                        <button class="btn danger" type="submit">Âà†Èô§</button>
                      </form>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <div class="empty" style="margin: 0;">
              ËØ•Êñá‰ª∂Â§πÊöÇÊó†Êñá‰ª∂
            </div>
          {% endif %}
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="empty">
        ÊöÇÊó†Êñá‰ª∂„ÄÇ
        <a class="btn" href="{{ url_for('user.upload_files') }}" style="margin-left:8px;">Âéª‰∏ä‰º†</a>
      </div>
    {% endif %}
  </div>
  
  <script>
    function toggleFolder(folderId) {
      const content = document.getElementById(folderId);
      const toggleBtn = document.getElementById('toggle-' + folderId);
      
      if (content.classList.contains('show')) {
        content.classList.remove('show');
        toggleBtn.classList.remove('expanded');
        toggleBtn.classList.add('collapsed');
        toggleBtn.textContent = '‚ñ∂';
      } else {
        content.classList.add('show');
        toggleBtn.classList.remove('collapsed');
        toggleBtn.classList.add('expanded');
        toggleBtn.textContent = '‚ñº';
      }
    }
  </script>
</body>
</html>