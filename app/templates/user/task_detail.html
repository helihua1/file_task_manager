{% extends "base.html" %}

{% block title %}{{ task.task_name }} - 任务详情{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-tasks me-2"></i>{{ task.task_name }}
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{{ url_for('user.task_list') }}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> 返回列表
            </a>
            {% if task.status == 'pending' %}
                <form method="POST" action="{{ url_for('user.start_task', task_id=task.id) }}" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-success">
                        <i class="fas fa-play"></i> 启动任务
                    </button>
                </form>
            {% elif task.status == 'running' %}
                <form method="POST" action="{{ url_for('user.pause_task', task_id=task.id) }}" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-warning">
                        <i class="fas fa-pause"></i> 暂停任务
                    </button>
                </form>
            {% elif task.status == 'paused' %}
                <form method="POST" action="{{ url_for('user.start_task', task_id=task.id) }}" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-success">
                        <i class="fas fa-play"></i> 恢复任务
                    </button>
                </form>
            {% endif %}
        </div>
    </div>
</div>

<!-- 任务状态卡片 -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card shadow">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>任务信息
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <td class="fw-bold text-muted">任务名称:</td>
                                <td>{{ task.task_name }}</td>
                            </tr>
                            <tr>
                                <td class="fw-bold text-muted">目标URL:</td>
                                <td>
                                    {% for url in task.target_url.split(',') %}
                                        <a href="{{ url.strip() }}" target="_blank" class="text-decoration-none">
                                            {{ url.strip() }} <i class="fas fa-external-link-alt"></i>
                                        </a><br>
                                    {% endfor %}
                                </td>
                            </tr>
                            <tr>
                                <td class="fw-bold text-muted">执行方法:</td>
                                <td>{{ task.execution_method }}</td>
                            </tr>
                            <tr>
                                <td class="fw-bold text-muted">源文件夹:</td>
                                <td>
                                    <span class="badge bg-info">
                                        <i class="fas fa-folder me-1"></i>{{ task.source_folder}}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td class="fw-bold text-muted">备用文件夹:</td>
                                <td>
                                    {% if task.backup_folders %}
                                    <!-- 调用app中的init.py 的from_json过滤器 -->
                                        {% set backup_list = task.backup_folders|from_json %}
                                        {% for folder in backup_list %}
                                        <span class="badge bg-secondary me-1">
                                            <i class="fas fa-folder me-1"></i>{{ folder }}
                                        </span>
                                        {% endfor %}
                                    {% else %}
                                        <span class="text-muted">无</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <td class="fw-bold text-muted">执行间隔:</td>
                                <td>{{ task.interval_seconds }} 秒</td>
                            </tr>
                            <tr>
                                <td class="fw-bold text-muted">开始时间:</td>
                                <td>{{ task.start_time.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                            </tr>
                            <tr>
                                <td class="fw-bold text-muted">结束时间:</td>
                                <td>
                                    {% if task.end_time %}
                                        {{ task.end_time.strftime('%Y-%m-%d %H:%M:%S') }}
                                    {% else %}
                                        <span class="text-muted">无限制</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td class="fw-bold text-muted">每日开始时间:</td>
                                <td>
                                    {% if task.daily_start_time %}
                                        {{ task.daily_start_time.strftime('%H:%M') }}
                                    {% else %}
                                        <span class="text-muted">无限制</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td class="fw-bold text-muted">每日执行数量:</td>
                                <td>{{ task.daily_execution_count }} 个文件</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card shadow">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>执行状态
                </h5>
            </div>
            <div class="card-body text-center">
                <!-- 状态徽章 -->
                <div class="mb-3">
                    {% if task.status == 'running' %}
                        <span class="badge bg-success fs-6">
                            <i class="fas fa-play me-1"></i>运行中
                        </span>
                    {% elif task.status == 'pending' %}
                        <span class="badge bg-secondary fs-6">
                            <i class="fas fa-clock me-1"></i>待启动
                        </span>
                    {% elif task.status == 'paused' %}
                        <span class="badge bg-warning fs-6">
                            <i class="fas fa-pause me-1"></i>已暂停
                        </span>
                    {% elif task.status == 'completed' %}
                        <span class="badge bg-primary fs-6">
                            <i class="fas fa-check me-1"></i>已完成
                        </span>
                    {% elif task.status == 'failed' %}
                        <span class="badge bg-danger fs-6">
                            <i class="fas fa-exclamation-triangle me-1"></i>失败
                        </span>
                    {% endif %}
                </div>
                

                
                <!-- 统计信息 -->
                <div class="row text-center">
                    <div class="col-6">
                        <div class="border-end">
                            <h4 class="text-primary mb-1">{{ task.executed_files_count }}</h4>
                            <small class="text-muted">已执行</small>
                        </div>
                    </div>

                </div>
                

                </div>
            </div>
        </div>
    </div>
</div>

<!-- 统计历史信息 -->
<div class="card shadow mb-4">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-chart-bar me-2"></i>执行统计
            <button class="btn btn-sm btn-primary ms-2" type="button" data-bs-toggle="collapse" 
                    data-bs-target="#statsCollapse" aria-expanded="false" aria-controls="statsCollapse">
                <i class="fas fa-eye me-1"></i>统计历史信息
            </button>
        </h5>
    </div>
    <div class="collapse" id="statsCollapse">
        <div class="card-body">
            {% if url_stats %}
                <div class="table-responsive">
                    <table class="table table-hover table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th width="40%">目标URL</th>
                                <th width="10%">栏目值</th>
                                <th width="15%">总执行数量</th>
                                <th width="15%">昨天执行数量</th>
                                <th width="15%">今天执行数量</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stat in url_stats %}
                            <tr>
                                <td>
                                    <small class="text-muted">{{ stat.url }}</small>
                                </td>
                                <td class="text-center">
                                    <span >{{ stat.menu_text }}</span>
                                </td>
                                <td class="text-center">
                                    <span >{{ stat.total_count }}</span>
                                </td>
                                <td class="text-center">
                                    <span >{{ stat.yesterday_count }}</span>
                                </td>
                                <td class="text-center">
                                    <span >{{ stat.today_count }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-3">
                    <i class="fas fa-chart-bar fa-2x text-muted mb-2"></i>
                    <p class="text-muted">暂无统计数据</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 执行历史 -->
<div class="card shadow">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-history me-2"></i>执行历史
            <span class="badge bg-secondary ms-2">{{ execution_history|length }} 条记录</span>
        </h5>
    </div>
    <div class="card-body">
        {% if execution_history %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th width="15%">执行时间</th>
                            <th width="10%">状态</th>
                            <th width="20%">文件id</th>
                            <th width="35%">响应数据</th>
                            <th width="20%">信息</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in execution_history %}
                        <tr>
                            <td>
                                <small class="text-muted">
                                    {{ record.execution_time }}
                                </small>
                            </td>
                            <td>
                                {% if record.status == '200success' %}
                                    <span class="badge bg-success">
                                        <i class="fas fa-check me-1"></i>{{record.status}}
                                    </span>
                                {% else %}
                                    <span class="badge bg-danger">
                                        <i class="fas fa-times me-1"></i>{{record.status}}
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <small class="text-muted">
                                    {{record.file_id}}
                                </small>
                            </td>
                            <td>
                                {% if record.response_data %}

                                    <small class="text-muted">
                                        {{record.response_data}}
                                    </small>
<!--                                不能去掉 endif-->
                                {% else %}
                                    <span class="text-muted">无响应数据</span>
                                {% endif %}
                            </td>
                            <td>

                                {% if record.error_message == '增加信息成功' %}
                                    <span class="badge bg-success">
                                        <i class="fas fa-check me-1"></i>增加信息成功
                                    </span>
                                {% else %}
                                    <span class="badge bg-danger">
                                        <i class="fas fa-times me-1"></i>{{record.status}}
                                    </span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-history fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">暂无执行记录</h5>
                <p class="text-muted">任务执行后，这里将显示详细的执行历史</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.progress-container {
    position: relative;
}

.progress-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 0.75rem;
    font-weight: bold;
    color: #333;
}

.table th {
    border-top: none;
    font-weight: 600;
    color: #5a5c69;
}

.table td {
    vertical-align: middle;
}

.badge {
    font-size: 0.75rem;
    padding: 0.375rem 0.75rem;
}

.card-header {
    background-color: #f8f9fc;
    border-bottom: 1px solid #e3e6f0;
}

.btn-group .btn {
    margin-right: 5px;
}

.btn-group .btn:last-child {
    margin-right: 0;
}

pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    max-height: 200px;
    overflow-y: auto;
}

.border-end {
    border-right: 1px solid #dee2e6 !important;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// 自动刷新页面以更新任务状态（每30秒）
setInterval(function() {
    // 只刷新运行中的任务
    if ('{{ task.status }}' === 'running') {
        location.reload();
    }
}, 30000);

// 任务操作确认
document.addEventListener('click', function(e) {
    if (e.target.closest('form[action*="start_task"]')) {
        if (!confirm('确认启动此任务吗？')) {
            e.preventDefault();
        }
    }
    
    if (e.target.closest('form[action*="pause_task"]')) {
        if (!confirm('确认暂停此任务吗？')) {
            e.preventDefault();
        }
    }
});

</script>
{% endblock %} 